<div class="create-post-page">
  <div class="page-header">
    <h1>Create New Post</h1>
    <p class="subtitle">Report a problem in your community</p>
  </div>

  <form [formGroup]="postForm" (ngSubmit)="onSubmit()" class="post-form">
    <!-- Map Selection Section - NOW STEP 1 -->
    <section class="form-section">
      <div class="section-header">
        <div class="section-number">1</div>
        <div>
          <h2>Pinpoint Exact Location</h2>
          <p class="section-description">Click on the map to select the exact coordinates of the problem</p>
        </div>
      </div>
      <div class="section-content">
        <app-map [initialCoordinates]="selectedCoordinates()"
          (coordinatesSelected)="onCoordinatesSelected($event)"></app-map>
        @if (selectedCoordinates()) {
        @if (isReverseGeocoding()) {
        <div class="location-info location-loading">
          <div class="info-label">
            <span class="spinner"></span>
            <span>Identifying location...</span>
          </div>
        </div>
        } @else if (reverseGeocodedLocation()) {
        <div class="location-info location-detected">
          <div class="info-label">üìç Location Details:</div>
          <div class="info-value">{{ reverseGeocodedLocation()!.displayName }}</div>
          <div class="info-details">
            @if (reverseGeocodedLocation()!.city) {
            <span>City: {{ reverseGeocodedLocation()!.city }}</span>
            }
            @if (reverseGeocodedLocation()!.state) {
            <span> ‚Ä¢ State/Region: {{ reverseGeocodedLocation()!.state }}</span>
            }
            @if (reverseGeocodedLocation()!.country) {
            <span> ‚Ä¢ Country: {{ reverseGeocodedLocation()!.country }}</span>
            }
          </div>
        </div>
        }
        } @else {
        <div class="validation-hint">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <circle cx="8" cy="8" r="7" stroke="#F59E0B" stroke-width="2" />
            <path d="M8 4v5M8 11v1" stroke="#F59E0B" stroke-width="2" stroke-linecap="round" />
          </svg>
          <span>Please click on the map to select coordinates</span>
        </div>
        }
      </div>
    </section>

    <!-- Location Search Section - NOW STEP 2 (AUTO-POPULATED) -->
    <section class="form-section">
      <div class="section-header">
        <div class="section-number">2</div>
        <div>
          <h2>Select City/Location</h2>
          <p class="section-description">
            Adjust if auto-detected location is not accurate. This will be used to search your post by city.
          </p>
        </div>
      </div>
      <div class="section-content">
        <app-location-selector (locationSelectedEvent)="onLocationSelected($event)"></app-location-selector>
        @if (selectedLocation()) {
        <div class="location-info location-selected">
          <div class="info-label">‚úÖ Selected City/Place:</div>
          <div class="info-value">{{ selectedLocation()!.name }}</div>
          <div class="info-note">Used for filtering posts by location</div>
        </div>
        } @else {
        <div class="validation-hint">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <circle cx="8" cy="8" r="7" stroke="#F59E0B" stroke-width="2" />
            <path d="M8 4v5M8 11v1" stroke="#F59E0B" stroke-width="2" stroke-linecap="round" />
          </svg>
          <span>Please select a location from the dropdown</span>
        </div>
        }
        @if (locationSelectionError()) {
        <div class="error-message-box">
          {{ locationSelectionError() }}
        </div>
        }
      </div>
    </section>

    <!-- Images Section -->
    <section class="form-section">
      <div class="section-header">
        <div class="section-number">3</div>
        <div>
          <h2>Add Images (Optional)</h2>
          <p class="section-description">Upload images to illustrate the problem</p>
        </div>
      </div>
      <div class="section-content">
        <app-image-upload (imageIdsChanged)="onImageIdsChanged($event)"></app-image-upload>
      </div>
    </section>

    <!-- Title and Body Section -->
    <section class="form-section">
      <div class="section-header">
        <div class="section-number">4</div>
        <div>
          <h2>Describe the Problem</h2>
          <p class="section-description">Provide a clear title and detailed description</p>
        </div>
      </div>
      <div class="section-content">
        <div class="form-group">
          <label for="title">
            Post Title <span class="required">*</span>
          </label>
          <input type="text" id="title" formControlName="title" placeholder="e.g., Broken street light on Main Street"
            [class.invalid]="titleControl?.invalid && titleControl?.touched">
          @if (titleControl?.invalid && titleControl?.touched) {
          <div class="error-messages">
            @if (titleControl?.errors?.['required']) {
            <small class="error-message">Title is required</small>
            }
            @if (titleControl?.errors?.['maxlength']) {
            <small class="error-message">
              Title must be at most 100 characters (current: {{ (titleControl?.value?.length || 0) }})
            </small>
            }
          </div>
          }
          <div class="character-count">
            {{ titleControl?.value?.length || 0 }} / 100
          </div>
        </div>

        <div class="form-group">
          <label for="body">
            Description <span class="required">*</span>
          </label>
          <textarea id="body" formControlName="body" rows="10"
            placeholder="Provide detailed information about the problem, when you noticed it, and any other relevant details..."
            [class.invalid]="bodyControl?.invalid && bodyControl?.touched"></textarea>
          @if (bodyControl?.invalid && bodyControl?.touched) {
          <div class="error-messages">
            @if (bodyControl?.errors?.['required']) {
            <small class="error-message">Description is required</small>
            }
            @if (bodyControl?.errors?.['maxlength']) {
            <small class="error-message">
              Description must be at most 10,000 characters (current: {{ (bodyControl?.value?.length || 0) }})
            </small>
            }
          </div>
          }
          <div class="character-count">
            {{ bodyControl?.value?.length || 0 }} / 10,000
          </div>
        </div>
      </div>
    </section>

    <!-- Submit Section -->
    <div class="submit-section">
      <button type="submit" class="submit-button"
        [disabled]="isSubmitting() || postForm.invalid || !selectedCoordinates() || !selectedLocation() || isReverseGeocoding()">
        @if (isSubmitting()) {
        <span class="spinner"></span>
        <span>Creating Post...</span>
        } @else {
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
        </svg>
        <span>Create Post</span>
        }
      </button>
      <p class="submit-hint">
        Make sure all required fields are filled before submitting
      </p>
    </div>
  </form>
</div>
